define(["jquery","ztree"],function($,ztree){function treeLoader(){this.firstClicked=false;var self=this;this.zTreeObj=false;this.setting={view:{showLine:true},edit:{enable:true,showRemoveBtn:false,showRenameBtn:false},callback:{onClick:function(event,treeId,treeNode){},beforeRename:function(treeId,treeNode,newName){var zTree=self._getZtreeObj();if(newName.length===0){alert("节点名称不能为空.");setTimeout(function(){zTree.editName(treeNode)},10);return false}else{var aFolderId=treeNode.dataId===false?0:treeNode.dataId;var aParentId=defaultValue(treeNode.parentId,0);$.post("/StudyPoint/MainPointsFolder",{aFolderId:aFolderId,aFolderName:newName,aParentId:aParentId},function(R){R=R.toJson();if(R.s<0){if(R.s===-2){alert("目录名已存在!");setTimeout(function(){zTree.editName(treeNode)},10)}else{alert("目录操作失败!")}}else{if(R.s>0){treeNode.dataId=parseInt(R.s)}}})}return true},onNodeCreated:function(event,treeId,treeNode){if(!self.firstClicked){$("#"+treeNode.tId+"_a").click();self.firstClicked=true}}}};this.editing=false;this.init=function(_TreeDiv,requestURI,_callback){Loading.start(_TreeDiv);$.get(requestURI,function(zNodes){Loading.finish();zNodes=zNodes.toJson();self.zTreeObj=$.fn.zTree.init($(_TreeDiv),self.setting,zNodes);if(typeof _callback!=="undefined"){_callback()}})};this.addFolder=function(){self.editing=true;nodes=self.zTreeObj.getSelectedNodes(),treeNode=nodes[0];var parentId=treeNode?treeNode.dataId:0;var nodeData={dataId:false,pId:parentId,parentId:parentId,isParent:false,name:"未命名目录"};if(treeNode){nodeData.isParent=false;treeNode=self.zTreeObj.addNodes(treeNode,nodeData)}else{nodeData.isParent=true;treeNode=self.zTreeObj.addNodes(null,nodeData)}if(treeNode){self.zTreeObj.editName(treeNode[0])}else{alert("叶子节点被锁定，无法增加子节点")}nodeData=null};this.editFolder=function(){var zTree=self.zTreeObj;nodes=zTree.getSelectedNodes(),treeNode=nodes[0];if(nodes.length===0){alert("请先选择一个节点");return}zTree.editName(treeNode)};this.delFolder=function(){var snode=self.getSnode();if(snode&&confirm("确定要删除选中的要点目录吗?")){var aParentId=defaultValue(snode.parentId,0);$.post("/StudyPoint/MainPointsFolder",{aFolderId:(-1)*snode.dataId,aFolderName:snode.name,aParentId:aParentId},function(R){var R=eval("("+R+")");if(R.s==="0"){$("#"+snode.tId).remove()}else{alert("删除失败")}})}};this.getSnode=function(){var zTree=self.zTreeObj;var nodes=zTree.getSelectedNodes();if(nodes.length!==0){for(var i in nodes){return nodes[i]}}else{return false}}}return new treeLoader()});